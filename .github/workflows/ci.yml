name: ğŸ”„ CI

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

# Permissions for GITHUB_TOKEN
permissions:
  contents: read # Required to checkout code
  issues: read # Required for security scanning
  pull-requests: read # Required for PR context

env:
  # Performance monitoring
  CI_START_TIME: ${{ github.event.head_commit.timestamp }}
  CACHE_VERSION: v2
  # Python testing environment
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

jobs:
  test:
    name: ğŸ Test Python CLI (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip" # Cache pip dependencies

      - name: ğŸ“¦ Cache Poetry installation
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/pypoetry
            ~/.local/bin/poetry
          key: poetry-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}

      - name: ğŸ“¦ Load workflow utilities
        run: |
          chmod +x .github/scripts/workflow_utils.sh
          source .github/scripts/workflow_utils.sh
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ”§ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ï¿½ Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-test-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            venv-test-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}-
            venv-test-${{ runner.os }}-${{ matrix.python-version }}-

      - name: ï¿½ğŸ“š Install dependencies
        run: |
          source .github/scripts/workflow_utils.sh
          poetry install

      - name: âœ… Validate environment
        run: |
          source .github/scripts/workflow_utils.sh
          validate_environment "python${{ matrix.python-version }}" "git curl poetry"

      - name: ğŸ Test Python CLI syntax
        run: |
          source .github/scripts/workflow_utils.sh
          print_message "step" "Validating Python CLI syntax"

          # Test Python syntax and imports
          poetry run python -m py_compile classroom_pilot/__main__.py
          poetry run python -m py_compile classroom_pilot/cli.py

          # Test CLI help commands
          poetry run python -m classroom_pilot --help
          poetry run python -m classroom_pilot assignments --help
          poetry run python -m classroom_pilot repos --help
          poetry run python -m classroom_pilot secrets --help
          poetry run python -m classroom_pilot automation --help

          print_message "success" "Python CLI validation completed"

      - name: ğŸ§ª Test CLI functionality
        run: |
          source .github/scripts/workflow_utils.sh

          # Create comprehensive test files
          echo '{"assignment":"test","version":"1.0"}' > assignment.json
          echo '{"cells":[],"metadata":{},"nbformat":4,"nbformat_minor":4}' > test.ipynb
          echo '{"test_secret": "test_value"}' > test-secrets.json

          # Test Python CLI help commands
          print_message "info" "Testing Python CLI help commands"
          poetry run python -m classroom_pilot --help > /dev/null
          poetry run python -m classroom_pilot assignments --help > /dev/null
          poetry run python -m classroom_pilot repos --help > /dev/null
          poetry run python -m classroom_pilot secrets --help > /dev/null
          poetry run python -m classroom_pilot automation --help > /dev/null

          print_message "success" "All Python CLI help commands working"

      - name: ğŸ§ª Run comprehensive test suite
        run: |
          source .github/scripts/workflow_utils.sh
          print_message "info" "Running comprehensive pytest test suite"

          # Create test results directory
          mkdir -p test-results/python${{ matrix.python-version }}

          # Run pytest with comprehensive coverage
          poetry run pytest tests/ \
            -v \
            --tb=short \
            --strict-markers \
            --disable-warnings \
            --cov=classroom_pilot \
            --cov-branch \
            --cov-report=term-missing:skip-covered \
            --cov-report=xml:test-results/python${{ matrix.python-version }}/coverage.xml \
            --cov-report=html:test-results/python${{ matrix.python-version }}/htmlcov \
            --junitxml=test-results/python${{ matrix.python-version }}/pytest-results.xml

          print_message "success" "All tests passed for Python ${{ matrix.python-version }}"

      - name: ğŸ“Š Upload test results and coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-python${{ matrix.python-version }}
          path: |
            test-results/python${{ matrix.python-version }}/
          retention-days: 30

      - name: ğŸ“Š Generate test summary
        if: always()
        run: |
          source .github/scripts/workflow_utils.sh

          # Calculate step timing
          step_duration=$(report_step_timing "Test Python CLI (Python ${{ matrix.python-version }})" "$STEP_START_TIME")

          # Export performance metrics for aggregation
          export_performance_metrics "test_python_cli_${{ matrix.python-version }}" "/tmp/workflow_metrics.json"

          # Create comprehensive summary
          if [ "${{ job.status }}" = "success" ]; then
            create_step_summary "Test Python CLI (Python ${{ matrix.python-version }})" "success" "| Python Version | ${{ matrix.python-version }} |\n| Duration | ${step_duration}s |"
          else
            error_report=$(generate_error_report "Test Python CLI (Python ${{ matrix.python-version }})" "Python CLI testing failed" "Matrix: Python ${{ matrix.python-version }}" "- Check Python installation\n- Verify CLI module imports\n- Review command implementation")
            echo "$error_report" >> $GITHUB_STEP_SUMMARY
            create_step_summary "Test Python CLI (Python ${{ matrix.python-version }})" "failure"
          fi

  lint:
    name: ğŸ” Python Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Cache Poetry installation
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/pypoetry
            ~/.local/bin/poetry
          key: poetry-${{ runner.os }}-${{ hashFiles('.github/workflows/ci.yml') }}

      - name: ğŸ“¦ Load workflow utilities
        run: |
          chmod +x .github/scripts/workflow_utils.sh
          source .github/scripts/workflow_utils.sh
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ”§ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ“¦ Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-lint-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            venv-lint-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}-
            venv-lint-${{ runner.os }}-3.11-

      - name: ğŸ“š Install dependencies
        run: |
          source .github/scripts/workflow_utils.sh
          poetry install

      - name: ğŸ” Run Python code quality checks
        run: |
          source .github/scripts/workflow_utils.sh
          print_message "step" "Running Python code quality analysis"

          # Check Python syntax
          log_info "Checking Python syntax..."
          poetry run python -m py_compile classroom_pilot/*.py

          # Test imports
          log_info "Testing module imports..."
          poetry run python -c "import classroom_pilot; print('âœ… Package imports successfully')"

          # Test CLI functionality
          log_info "Testing CLI functionality..."
          poetry run python -m classroom_pilot --help > /dev/null

          print_message "success" "Python code quality checks passed"

      - name: ğŸ“Š Generate lint summary
        if: always()
        run: |
          source .github/scripts/workflow_utils.sh
          step_duration=$(report_step_timing "Python Code Quality" "$STEP_START_TIME")

          # Export performance metrics for aggregation
          export_performance_metrics "python_code_quality" "/tmp/workflow_metrics.json"

          if [ "${{ job.status }}" = "success" ]; then
            create_step_summary "Python Code Quality" "success" "| Tool | Python syntax + imports |\n| Duration | ${step_duration}s |"
          else
            create_step_summary "Python Code Quality" "failure"
          fi

  test-matrix-summary:
    name: ğŸ“Š Test Matrix Summary
    runs-on: ubuntu-latest
    needs: [test]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code (for utilities)
        uses: actions/checkout@v4

      - name: ğŸ“¦ Load workflow utilities
        run: |
          chmod +x .github/scripts/workflow_utils.sh
          source .github/scripts/workflow_utils.sh

      - name: ğŸ“Š Generate test matrix summary
        run: ./.github/scripts/generate_test_matrix_summary.sh "${{ needs.test.result }}"

  security:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Cache security tools
        uses: actions/cache@v4
        with:
          path: |
            /tmp/security-scan-cache
            ~/.cache/trivy
            ~/.cache/pip
          key: security-tools-${{ runner.os }}-${{ hashFiles('.github/scripts/security_utils.sh') }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            security-tools-${{ runner.os }}-${{ hashFiles('.github/scripts/security_utils.sh') }}-
            security-tools-${{ runner.os }}-

      - name: ğŸ“¦ Load workflow utilities
        run: |
          chmod +x .github/scripts/workflow_utils.sh
          source .github/scripts/workflow_utils.sh
          echo "STEP_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ—‚ï¸ Setup security cache directories
        run: |
          source .github/scripts/workflow_utils.sh
          create_directory_if_not_exists "/tmp/security-scan-cache"
          create_directory_if_not_exists "/tmp/security-reports"

      - name: ğŸ“¦ Export Poetry dependencies
        run: |
          chmod +x .github/scripts/export_poetry_dependencies.sh
          .github/scripts/export_poetry_dependencies.sh

      - name: ğŸ” Security audit
        run: |
          chmod +x .github/scripts/security_utils.sh
          .github/scripts/security_utils.sh audit

      - name: ğŸ“Š Security report summary
        run: |
          .github/scripts/security_utils.sh summary
